<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCV Background Subtraction</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>
<body>
    <video id="videoInput" width="640" height="480" autoplay></video>
    <canvas id="canvasOutput" width="640" height="480"></canvas>

    <script>
        // Request camera access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                let video = document.getElementById('videoInput');
                video.srcObject = stream;
                video.play();

                // Wait until video metadata is loaded (dimensions ready)
                video.addEventListener('loadedmetadata', onVideoLoaded, false);
            })
            .catch((err) => {
                console.error("Error accessing camera: " + err);
            });

        // OpenCV initialization
        cv['onRuntimeInitialized'] = () => {
            console.log("OpenCV.js is ready.");
        };

        function onVideoLoaded() {
            let video = document.getElementById('videoInput');
            let canvas = document.getElementById('canvasOutput');
            let cap = new cv.VideoCapture(video);

            // Initialize Mats for frame and mask
            let frame = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            let fgmask = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
            let fgbg = new cv.BackgroundSubtractorMOG2(500, 16, false);

            const FPS = 30;
            function processVideo() {
                try {
                    // Capture frame and apply background subtraction
                    cap.read(frame);
                    fgbg.apply(frame, fgmask);

                    // Display result on canvas
                    cv.imshow(canvas, fgmask);

                    // Schedule next frame processing
                    setTimeout(processVideo, 1000 / FPS);
                } catch (err) {
                    console.error(err);
                }
            }

            // Start processing
            processVideo();
        }
    </script>
</body>
</html>
